---
title: "Find a proper job in NYC -- Job analysis of NYC"
author: "p8105 Goup 13"
date: "November 21, 2017"
output: html_document
editor_options: 
  chunk_output_type: console
---
#Member:
Huilin Zhou (hz2507)  
Zhuo Li (zl2637)  
Qing Xu (qx2178)  
Zhaoyu Liu (zl2638)  

#Motivation: 
Many of us will find a job in recent years. In New York City, what type of job can be payed for higher salary? If that's the ideal job for me , what skills should I have before applying for it?  Also where should I rent an apartment if I want to live close to that type of positions? By looking at the NYC jobs data set from 2013 to 2017,we wish to give some advice on job catrgory, required skills and salary for people who are seeking for a job.  

#Initial questions:
What questions are you trying to answer? How did these questions evolve over the course of the project? What new questions did you consider in the course of your analysis?

#Data: 
Source: https://data.cityofnewyork.us/City-Government/NYC-Jobs/kpav-sd4t/data  
Scrape:We doWnloaded the data set from the website and the original data set contains 3174 job information. We selected data with information about work location, job category, preferred skills and full/part time. We want to use Google Map to get longtitute and latitute from work locations. Since the Google map has a limit of 2500 observation one time, we selected first 2500 observations from the data set.  
Cleaning:  
1. Merged job category if they are the same kind but just have different names. Finally we got 12 kinds of job categories.    
2. Unified salary unit to "Annual" and recalculated the salary range and average salary.   
3. Used Google Map to change location to longitute and latitute.   
  
```{r,warning=FALSE,echo=FALSE,message=FALSE}
library(tidyverse)
library(haven)
library(readxl)
library(janitor)
library(ggmap)
library(plotly)
library(stringr)
library(wordcloud2)
library(tidytext)
library(forcats)
library(viridis)
```


```{r,warning=FALSE,echo=FALSE}
#clean data
nyc_jobs<- read.csv("NYC_Jobs.csv") %>%
  clean_names() %>%
  filter(job_category!= " ", 
         full_time_part_time_indicator!=" ", 
         preferred_skills!= " ",
         work_location!=" ") %>%
  head(2500) #google map limited to 2500
nyc_jobs$job_category<- as.character(nyc_jobs$job_category)

#combine job category (function?)
for (i in 1:2500) {
    nyc_jobs$job_category[[i]][str_detect(nyc_jobs$job_category[[i]],regex("engineering", ignore_case = TRUE))] <- "Engineering"
    nyc_jobs$job_category[[i]][str_detect(nyc_jobs$job_category[[i]],regex("finance", ignore_case = TRUE))] <- "Finance"
    nyc_jobs$job_category[[i]][str_detect(nyc_jobs$job_category[[i]],regex("legal", ignore_case = TRUE))] <- "Legal Affairs"
    nyc_jobs$job_category[[i]][str_detect(nyc_jobs$job_category[[i]],regex("technology", ignore_case = TRUE))] <- "Technology"
    nyc_jobs$job_category[[i]][str_detect(nyc_jobs$job_category[[i]],regex("policy", ignore_case = TRUE))] <- "Policy"
    nyc_jobs$job_category[[i]][str_detect(nyc_jobs$job_category[[i]],regex("communi", ignore_case = TRUE))] <- "Community"
    nyc_jobs$job_category[[i]][str_detect(nyc_jobs$job_category[[i]],regex("clerical", ignore_case = TRUE))] <- "Clerical"
    nyc_jobs$job_category[[i]][str_detect(nyc_jobs$job_category[[i]],regex("social service", ignore_case = TRUE))] <- "Social service"
    nyc_jobs$job_category[[i]][str_detect(nyc_jobs$job_category[[i]],regex("public safety", ignore_case = TRUE))] <- "Public safety"
    nyc_jobs$job_category[[i]][str_detect(nyc_jobs$job_category[[i]],regex("administration", ignore_case = TRUE))] <- "Administration"
    nyc_jobs$job_category[[i]][str_detect(nyc_jobs$job_category[[i]],regex("operations", ignore_case = TRUE))] <- "Maintance"
    nyc_jobs$job_category[[i]][str_detect(nyc_jobs$job_category[[i]],regex("maintenance ", ignore_case = TRUE))] <- "Maintance"
    
}


# change unit of salary and calculate mean
nyc_jobs$salary_frequency<-as.character((nyc_jobs$salary_frequency))
nyc_jobs$salary_range_from<- as.numeric(nyc_jobs$salary_range_from)
nyc_jobs$salary_range_to<- as.numeric(nyc_jobs$salary_range_to)
nyc_jobs$salary_range_from <- with(nyc_jobs, ifelse(salary_frequency == "Hourly", salary_range_from*1825,salary_range_from))
nyc_jobs$salary_range_to <- with(nyc_jobs, ifelse(salary_frequency == "Hourly", salary_range_to*1825,salary_range_to))
nyc_jobs$salary_range_from <- with(nyc_jobs, ifelse(salary_frequency == "Daily", salary_range_from*365*5/7,salary_range_from))
nyc_jobs$salary_range_to <- with(nyc_jobs, ifelse(salary_frequency == "Daily", salary_range_to*365*5/7,salary_range_to))

nyc_jobs<-mutate(nyc_jobs,salary_frequency="Annual") %>%
          mutate(salary_mean = (salary_range_to-salary_range_from)/2+salary_range_from)
```

```{r,message=FALSE,echo=FALSE,warning=FALSE}

# get lon and lat
nyc_jobs$work_location<-as.character(nyc_jobs$work_location)
geo <- geocode(location = nyc_jobs$work_location, output="latlon", source="google")
nyc_jobs<- nyc_jobs %>%
  mutate(lon = geo$lon, lat = geo$lat) %>%
  group_by(job_category)

```
#Exploratory analysis: 

##location map
First, we use longtitue and latitute of 2500 observations and plot their location in the map by different job category and text with average annual salary.  
```{r,message=FALSE,warning=FALSE}
# plotly worldwild
Sys.setenv('MAPBOX_TOKEN' = 'pk.eyJ1IjoieHVxaW5nc2FsbHkiLCJhIjoiY2phZWh0djdyMHUzZTJ3bGR3MHFsdmIzZSJ9.vhYtu7zeAAuX6slhdDj6lA')

p <- nyc_jobs %>%
  mutate(text_label = str_c("Annual mean salary$:",salary_mean))

plot_mapbox(p,lat = ~lat, lon = ~lon,
              size=2,
              split = nyc_jobs$job_category,
              mode = 'scattermapbox') %>%
  add_markers(
    text = ~text_label,
    color = ~job_category,size = I(8)) %>%
  layout(title = 'Work Location',
         font = list(color='white'),
         plot_bgcolor = '#191A1A', paper_bgcolor = '#191A1A',
         mapbox = list(style = 'dark'),
         legend = list(orientation = 'h',
                       font = list(size = 8)),
         margin = list(l = 25, r = 25,
                       b = 25, t = 25,
                       pad = 2))
```
Although the data set is about the job information of NY, there are some work locations outside NY.  

# Boxplot of salary in different job category
We draw the distribution of average annual salary of different job categories.
```{r,warning=FALSE}
plot_ly(nyc_jobs,y = ~salary_mean, color = ~job_category, type = "box",
          colors = "Set2") %>%
layout(title = "Annual average salary distribution in 12 job categories")
```
We found that Technology and Engineering have high salary in as a Whole and Clerical jobs have lowest salary. It makes sense that most of technology and engineering work need advanced skills and knowledge which deserve great pay.  
Also in many areas, there are some outliers that have extreme high salary. So the amount of salary also depends on person that you can get far beyound average salary if you do well in your position. 

# Job types with different educational requirement and base salary

```{r,warning=FALSE,message=FALSE}
job_data=nyc_jobs%>%
select(job_category, salary_range_from, salary_range_to,minimum_qual_requirements,full_time_part_time_indicator,salary_frequency)%>%
filter(job_category!= " ", minimum_qual_requirements!=" ",full_time_part_time_indicator=="F",salary_frequency=="Annual")
 
x=c("baccalaureate", "Bachelor")
y=c("Master","master")

master_data=filter(job_data,grepl(paste(y, collapse = "|"),minimum_qual_requirements),!grepl(paste(x, collapse = "|"),minimum_qual_requirements))

baccalaureate_data = filter(job_data,grepl(paste(x, collapse = "|"),minimum_qual_requirements),!grepl(paste(y, collapse = "|"),minimum_qual_requirements))

Other_data=filter(job_data,!grepl(paste(y, collapse = "|"),minimum_qual_requirements),!grepl(paste(x, collapse = "|"),minimum_qual_requirements))
```

# Boxplots of salary for different educational requirement.

```{r,warning=FALSE,message=FALSE}
plot_ly(master_data, y = ~salary_range_from, color = ~job_category, type = "box", colors = "Set2")%>%
layout(title = "Base salary of  jobs required at least master degree")

plot_ly(baccalaureate_data, y = ~salary_range_from, color = ~job_category, type = "box", colors = "Set2")%>%
  layout(title = "Base salary of jobs required at least baccalaureate degree(No need of master's)")
  
plot_ly(Other_data, y = ~salary_range_from, color = ~job_category, type = "box",
          colors = "Set2")%>%
  layout(title = "Base salary of different kind of jobs without requirement of degree")

```

# The wage increasing ranges of different jobs

```{r,warning=FALSE,message=FALSE}
job_data=mutate(job_data, salary_range=salary_range_to-salary_range_from)

plot_ly(job_data, y=~salary_range, x= ~job_category, type="bar")%>%
  layout(title = "The wage increasing ranges of different kinds of jobs")
```

# Table of positions, agency and job category. 

```{r,warning=FALSE,message=FALSE}
job_positions = nyc_jobs %>%
  select(x_of_positions, agency, job_category, salary_mean) %>%
  distinct() %>%
  group_by(agency, job_category) %>%
  summarise(positions = sum(x_of_positions)) %>%
  arrange(desc(positions))

# Number of job positions: top 10
knitr::kable(head(job_positions, 10))
```

The table above shows the top-10 number of job positions in NYC from 2013 to 2017. `r job_positions[[1]][1]` with job category "Health" has the most job positions.

# Bar plot of job category vs. number of positions of each year.

```{r,warning=FALSE,message=FALSE}
positions_plot = nyc_jobs %>%
  select(x_of_positions, agency, job_category, salary_mean, posting_date) %>%
  distinct() %>%
  separate(posting_date, into = c("year", "month", "day"), sep = "-") %>%
  select(-month, -day) %>%
  group_by(job_category, year) %>%
  summarise(positions = sum(x_of_positions))

plot_ly(positions_plot, x = ~job_category, y = ~positions,
        color = ~year, type = "bar") %>%
  layout(title = "Number of positions of job categories in each year",
         barmode = "group")
```

The bar chart above shows the number of positions for each job category in each year. From 2013 to 2017, the number of job positions in each category keeps increasing. And all categories have a dramatically increase in job positions in 2017. This might because more and more companies were founded and developed in 2017, thus they need more employees joining in. Besides, since this dataset contains all job information from NYC official job website, as the year increases, more people found this website and created job postings on this site.

# Wordcount analysis of Preffered Skills and Minimum Qual Requirements
```{r}
nyc_jobs = nyc_jobs%>% 
  ungroup()%>%
  mutate(  minimum_qual_requirements = as.character(minimum_qual_requirements))%>%
  mutate(preferred_skills = as.character(preferred_skills))

jobs_words_skill =  nyc_jobs%>%
  unnest_tokens(word,preferred_skills)%>%
  anti_join(stop_words)%>%
  inner_join(., parts_of_speech) %>%
  count(word, sort = TRUE)
jobs_words_requirement =  nyc_jobs%>%
  unnest_tokens(word,minimum_qual_requirements)%>%
  anti_join(stop_words)%>%
  inner_join(., parts_of_speech) %>%
  count(word, sort = TRUE)

jobs_words_skill %>% 
  top_n(20) %>% 
  mutate(word = fct_reorder(word, n)) %>% 
  plot_ly(y = ~word, x = ~n, color = ~word, type = "bar")%>%
  layout(title = "Preferred Skills Word Counts")

jobs_words_requirement %>% 
  top_n(20) %>% 
  mutate(word = fct_reorder(word, n)) %>% 
  plot_ly(y = ~word, x = ~n, color = ~word, type = "bar")%>%
  layout(title = "Minimum Qual Requirements")
```

The word count plots of prefferred skills and minimum qual requirements. 
The word count plots of prefferred skills and minimum qual requirements. After deleting meaningless words, experience is the most used word both in prefeered skills and minimum requirement. We could see that word and excel is still the most common skill needed, and other skills for communication like written, verbal public speaking and oral is also like basic skills needed. 
For miminum qual requirements, education is really important, for that there are several words related to education shown on the plot such like "school", "college", "degree", "education", "graduate". Those words indicates a high requirement of education like bacherlor or master degree. And the word york indicates the requirement of residency in New York. For different knids of job, the skill and minimum requirement may change. The result of this part will be shown on the Shinny Website.
The word clouds of skills and minimum requirement are shown below, which indicates a more straight view of word frequency.

# Word Cloud of Preffered Skills and Minimum Qual Requirements
```{r}
set.seed(123)
wordcloud2(jobs_words_skill, size = 2,color = 'random-light',  
           backgroundColor = "gray", fontWeight='bold',  
           minRotation = -pi/3, maxRotation = pi/3,rotateRatio = 0.8)  
wordcloud2(jobs_words_requirement, size = 2,color = 'random-light',  
           backgroundColor = "gray", fontWeight='bold',  
           minRotation = -pi/3, maxRotation = pi/3,rotateRatio = 0.8)  
```

#Additional analysis:
If you undertake formal statistical analyses, describe these in detail  

#Discussion: 
What were your findings? Are they what you expect? What insights into the data can you make?

