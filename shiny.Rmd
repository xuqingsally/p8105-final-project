---
title: "Find a proper job in NYC -- Job analysis of NYC"
output: 
  flexdashboard::flex_dashboard:
     source_code: embed
  runtime: shiny
---

```{r setup, include=FALSE}
library(tidyverse)
library(haven)
library(readxl)
library(janitor)
library(ggmap)
library(plotly)
library(stringr)
library(wordcloud2)
library(tidytext)
library(forcats)
library(viridis)
library(shiny)
```

Column {.sidebar}
-----------------------------------------------------------------------
This `flexdashboard` with Shiny was made to provide information to help people find a job. The data come from [NYC Jobs](https://data.cityofnewyork.us/City-Government/NYC-Jobs/kpav-sd4t/data), which provides job information in New York from 2013 to 2017. 

```{r,warning=FALSE,echo=FALSE}
nyc_jobs<- read.csv("NYC_Jobs.csv") %>%
  clean_names() %>%
  filter(job_category!= " ", 
         full_time_part_time_indicator!=" ", 
         preferred_skills!= " ",
         work_location!=" ") %>%
  head(2500) #google map limited to 2500
nyc_jobs$job_category<- as.character(nyc_jobs$job_category)

#combine job category (function?)
for (i in 1:2500) {
    nyc_jobs$job_category[[i]][str_detect(nyc_jobs$job_category[[i]],regex("engineering", ignore_case = TRUE))] <- "Engineering"
    nyc_jobs$job_category[[i]][str_detect(nyc_jobs$job_category[[i]],regex("finance", ignore_case = TRUE))] <- "Finance"
    nyc_jobs$job_category[[i]][str_detect(nyc_jobs$job_category[[i]],regex("legal", ignore_case = TRUE))] <- "Legal Affairs"
    nyc_jobs$job_category[[i]][str_detect(nyc_jobs$job_category[[i]],regex("technology", ignore_case = TRUE))] <- "Technology"
    nyc_jobs$job_category[[i]][str_detect(nyc_jobs$job_category[[i]],regex("policy", ignore_case = TRUE))] <- "Policy"
    nyc_jobs$job_category[[i]][str_detect(nyc_jobs$job_category[[i]],regex("communi", ignore_case = TRUE))] <- "Community"
    nyc_jobs$job_category[[i]][str_detect(nyc_jobs$job_category[[i]],regex("clerical", ignore_case = TRUE))] <- "Clerical"
    nyc_jobs$job_category[[i]][str_detect(nyc_jobs$job_category[[i]],regex("social service", ignore_case = TRUE))] <- "Social service"
    nyc_jobs$job_category[[i]][str_detect(nyc_jobs$job_category[[i]],regex("public safety", ignore_case = TRUE))] <- "Public safety"
    nyc_jobs$job_category[[i]][str_detect(nyc_jobs$job_category[[i]],regex("administration", ignore_case = TRUE))] <- "Administration"
    nyc_jobs$job_category[[i]][str_detect(nyc_jobs$job_category[[i]],regex("operations", ignore_case = TRUE))] <- "Maintance"
    nyc_jobs$job_category[[i]][str_detect(nyc_jobs$job_category[[i]],regex("maintenance ", ignore_case = TRUE))] <- "Maintance"
    
}


# change unit of salary and calculate mean
nyc_jobs$salary_frequency<-as.character((nyc_jobs$salary_frequency))
nyc_jobs$salary_range_from<- as.numeric(nyc_jobs$salary_range_from)
nyc_jobs$salary_range_to<- as.numeric(nyc_jobs$salary_range_to)

#function?
nyc_jobs$salary_range_from <- with(nyc_jobs, ifelse(salary_frequency == "Hourly", salary_range_from*1825,salary_range_from))
nyc_jobs$salary_range_to <- with(nyc_jobs, ifelse(salary_frequency == "Hourly", salary_range_to*1825,salary_range_to))
nyc_jobs$salary_range_from <- with(nyc_jobs, ifelse(salary_frequency == "Daily", salary_range_from*365*5/7,salary_range_from))
nyc_jobs$salary_range_to <- with(nyc_jobs, ifelse(salary_frequency == "Daily", salary_range_to*365*5/7,salary_range_to))

nyc_jobs<-mutate(nyc_jobs,salary_frequency="Annual") %>%
          mutate(salary_mean = (salary_range_to-salary_range_from)/2+salary_range_from)


# get lon and lat
nyc_jobs$work_location<-as.character(nyc_jobs$work_location)
geo <- geocode(location = nyc_jobs$work_location, output="latlon", source="google")
nyc_jobs<- nyc_jobs %>%
  mutate(lon = geo$lon, lat = geo$lat) %>%
  group_by(job_category)

```

```{r}
month = noaa %>% distinct(month) %>% pull()


selectInput("month_choice", label = h3("Select month"),
            choices = month, selected = "01")
hr()

renderUI({
  max_prcp = noaa %>% filter(month == input$month_choice) %>% distinct(prcp) %>% max()
  
  min_prcp = noaa %>% filter(month == input$month_choice) %>% distinct(prcp) %>% min()
  
  sliderInput("prcp_range", label = h3("Choose Precipitation range"), min = min_prcp, 
        max = max_prcp, value = c(min, max))
})
```


Row
-----------------------------------------------------------------------

### Tmax against tmin

```{r}
renderPlotly({
hexplot = filter(noaa, !is.na(tmax))%>%
  filter(!is.na(tmin))%>%
  mutate(tmax = as.numeric(tmax))%>%
  mutate(tmin = as.numeric(tmin))%>%
  filter(month == input$month_choice,
         prcp %in% input$prcp_range[1]:input$prcp_range[2]) %>%
ggplot(aes(tmin, tmax)) +
  geom_hex()+
   labs(
    x = "Minimum temperature (tenths of degrees C)",
    y = "Maximum temperature (tenths of degrees C)",
    caption = "ny_noaa_data_year"
  ) + 
  theme_classic()
ggplotly(hexplot)
})

```

Row {.tabset .tabset-fade}
-----------------------------------------------------------------------

### Tmax distribution of each year
```{r}
renderPlotly({
  noaa<- noaa %>%
    group_by(year) %>%
    filter(month == input$month_choice,
    prcp %in% input$prcp_range[1]:input$prcp_range[2])
  
noaa$tmax<- as.numeric(noaa$tmax)
hist<- ggplot(noaa, aes(x =tmax , fill = year)) + 
  geom_histogram(alpha= 0.8) +
  labs(x = "Maximum temperature (tenths of degrees C)", y = "Number")

ggplotly(hist)
})

```



### Snowfall Distribution of each year

```{r}
renderPlotly({
ny_noaa_data_snowfall =
  filter(noaa, snow > 0 & snow < 100)%>%
  filter(month == input$month_choice,
         prcp %in% input$prcp_range[1]:input$prcp_range[2]) %>%
  ggplot(aes(x = year, y = snow, fill = year, color = year)) + 
  geom_violin()+ 
  labs(
    x = "year",
    y = "snowfall(mm)",
    caption = "Data from ny_noaa_data"
  ) + 
  theme(axis.text.x=element_text(angle=90,hjust=1)) + 
  theme(legend.position = "bottom")
ggplotly(ny_noaa_data_snowfall)
})
```


